# Partner API

## Typical Use Cases

### Working with Orders
- [Create an Order](#creating-orders)
- Check the status ‚Äì usually via a [webhook notification](#webhook-notifications-for-order-statuses), although in some cases you can explicitly request the [status of a group of orders](#retrieving-orders)
- Sometimes you need to [cancel an order](#canceling-orders) before it enters processing.

### Sometimes You May Need to Check
- [Pairs, Rates, Limits, and Commissions](#retrieving-current-pairs-rates-minimummaximum-amount-limits-and-reserves)
- [MineCoin Account Balances](#retrieving-minecoin-balances)

## Quick Start (Method Collection with Signature Automation in Postman)
For your convenience, we have created a collection in [Postman](https://www.postman.com/) that replicates all API methods. You can test its functionality and experiment with the requests.
1. In Postman, select the **Import File** option (for example, on the **Home** tab).
2. Switch to the **Link** tab and import the following URL:  
   `https://api.postman.com/collections/6328473-21626561-38fb-44cd-8c82-e24bc4047d2a?access_key=PMAT-01HT2VGXW98N3BSTC169WZ0HC7`
3. Hover over the imported collection, select the **Variables** tab, and enter your configuration in the **Current Value** column.

## Financial Control
For some pairs, order recalculation applies. This means that if an incorrect amount is received from the client, the order is recalculated and executed based on the received amount. When receiving the final status of an order (preferably via webhook), you must use the amounts provided in the API response in your system. It is unacceptable to rely on the credited amount without verifying the sums.

Also, we recommend regularly reconciling the balances from our API with those in your system.

## Network Loss Control
Although rare, the connection between servers may drop, so you need to validate that the response data is as expected:
1. If the request is processed correctly, the client will receive a 2xx HTTP code. Otherwise, an error occurred and the [response body contains its details](#standard-error-response-for-all-requests). Alternatively, you can check the `success` parameter in the JSON response body (1 if the request succeeded, otherwise 0).
2. The API always responds with JSON. If you do not receive valid JSON, you cannot be sure whether your request succeeded or was lost in transit. For critical requests (for example, payouts), verify such requests by any available means and do not consider the request completed (or failed) until you receive explicit confirmation:
    - In some cases, you can send a follow-up API request to check the status. For instance, if you made a payout request and are unsure if it went through, you can [check for the existence and status of the order](#retrieving-orders).
    - If automated verification is not possible, contact our technical support. Our support is very responsive, so in such exceptional situations you will receive an answer as quickly as possible.

## Security
For security, two keys are used: the authorization key and the signature key. Both keys are generated by the user in the personal account under the **API Settings** tab.

### API Authorization
For API authorization, an authorization key is used and must be provided as a header:
```js
Authorization: "Bearer {{AuthKey}}"
```

### Signing API Requests
For security reasons, API requests require a signature that hashes the request body using the signature key. The generated signature must be passed as a header:
```js
X-Signature: "{{Signature}}"
```

The signature is generated using the algorithm:
```php
hmac(sha256(SignatureKey, Request.Body))
```
*(Where **SignatureKey** is your signature key and **Request.Body** is the body of the specific request.)*

If the request body is absent (GET requests), the signature is generated from an empty string.

A similar [approach to signing requests](#verifying-the-authenticity-of-webhook-notifications) is used when sending webhook notifications from our side. In API requests from you to us, you generate the signature, and we verify it. When sending webhook notifications from us to you, the signature is generated by us, and you verify it.

For quick testing, we recommend using [our Postman collection](#quick-start-method-collection-with-signature-automation-in-postman).

### Allowed IP Addresses
For enhanced security, access to the API methods is allowed only from certain IP addresses (configured in your personal account under the **API Settings** tab).

You can specify the symbol "*" to allow access from all IP addresses, but we **strongly advise against doing this in production**.

## Headers for All API Requests
```json
{
    "Accept": "application/json",
    "Content-Type": "application/json",
    "Authorization": "Bearer {{auth_key}}",
    "X-Signature": "{{signature}}"
}
```

## Standard Error Response for All Requests
```json
{
    "success": 0,
    "code": "4xx-5xx",
    "errors": {
        "message": "{{error_message}}",
        "details": {}
    }
}
```

## Schema of the "Order" Object (Used in Many API Requests and Responses)
```js
{
    "order_id": "{{Partner system order ID}}",
    "inbound": {
        "currency": "{{Currency being sent}}",
        "account": "{{Sender's account}}",
        "amount": "{{Amount being sent}}",
        "amount_initial": "{{Initial send amount; used in API responses}}",
        "txid": "{{Incoming transaction ID; used in API responses}}", //nullable
        "code": "{{Payment code; used in API requests}}" //nullable        
    },
    "outbound": {
        "currency": "{{Payout currency}}",
        "account": "{{Recipient's account}}",
        "amount": "{{Payout amount}}",
        "amount_initial": "{{Initial payout amount; used in API responses}}", 
        "txid": "{{Outgoing transaction ID; used in API responses}}", //nullable
        "memo": "{{Cryptocurrency wallet memo; used in API requests}}" //nullable       
    },
    "is_customer_confirmation_need": "{{Flag indicating if customer confirmation is required; used in API responses}}",
    "rate": "{{Exchange rate; used in API responses}}",
    "rate_initial": "{{Initial exchange rate; used in API responses}}",
    "rate_type": "{{Type of exchange rate: inbound|outbound; used in API responses}}",
    "comment": "{{Order comment (optional)}}",
    "status": "{{Operation status: 'new|processing|incoming_unconfirmed|incoming_confirmed|moderation|error|canceled|success'; used in API responses}}",
    "created_at": "{{Creation time in ISO 8601 format; used in API responses}}",
    "updated_at": "{{Update time in ISO 8601 format; used in API responses}}"
}
```

### What is `amount_initial`?
When [initiating an order](#creating-orders), `amount_initial` is not provided. You must specify either `inbound.amount` or `outbound.amount`, which will then be immediately fixed as `amount_initial`.

Reasons why `amount` and `amount_initial` may differ:
- An order is created for CARDUAH ‚Üí BTC for 0.1 BTC. The calculation determines that 100k UAH is required, but only 50k was paid; the engine recalculates the order and pays out 0.05 BTC.
- Occasionally, slight discrepancies occur due to backend recalculations.

### Possible Values for the `status` Parameter

| **status**               | **Description**                                                                                                                                             |
|--------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **new**                  | New order, queued and not yet processed.                                                                                                                    |
| **processing**           | Order is being processed, awaiting action from the user.                                                                                                    |
| **incoming_unconfirmed** | After the client makes a payment, the system may see the transaction on the network but the funds have not yet arrived. This indicates a pending payment. |
| **incoming_confirmed**   | The client‚Äôs payment has been confirmed.                                                                                                                    |
| **moderation**           | Order is under review by a service manager (rare status).                                                                                                   |
| **error**                | An error occurred with the order. This status is not final; please contact technical support for clarification.                                               |
| **canceled**             | Order has been canceled (by the user or system). In MineCoin pairs, this indicates that the order is final, funds were not sent, and have been returned to the MineCoin account. Possible reasons include incorrect recipient details or bank restrictions. Once this status is received, you may retry the transaction. |
| **success**              | Funds have been paid out; order is completed.                                                                                                               |

## Mandatory Parameters That Complement Order Information

### Order.extra ‚Äî Additional Data Provided by the Partner When Creating the Order (Used in Requests and Responses)
```js
{
    "extra": {
        "success_url": "{{URL for redirection after successful payment}}", //nullable
        "failed_url": "{{URL for redirection after failed payment}}", //nullable
        "client": {
            "id": "{{User ID in your system}}",
            "email": "{{User's email address in your system}}",
            "phone": "{{User's phone number in your system}}", //nullable
            "first_name": "{{User's first name in your system}}", //nullable
            "last_name": "{{User's last name in your system}}", //nullable
            "middle_nanme": "{{User's middle name in your system}}", //nullable
            "ip": "{{IP address of the user performing the action in your system}}",
            "user_agent": "{{User agent (browser) of the user. Available in $_SERVER['HTTP_USER_AGENT'] for PHP developers}}"
        }
    }
}
```

## Optional Parameters That Complement Order Information

### Order.payment_variants ‚Äî Possible Payment Methods for the Order by the Client (Used in Responses)
```js
{
    "payment_variants": {
        "invoice": {
            "url": "{{https://***}}",
            "error": null | "{{Error description}}"
        },
        "direct": {
            "url": "{{https://***}}",
            "error": null | "{{Error description}}"
        },
        "manual": {
            "number": "{{***}}",
            "memo": null | "{{memo}}",
            "error": null | "{{Error description}}"
        }
    }
}
```   
*Payment variants details depend on the receiving payment system.*

| **Payment System**  | **Object in payment_variants** | **Description**                                                            |
|---------------------|---------------------------------|----------------------------------------------------------------------------|
| **Jumbo**           | invoice                         | (url) A link to redirect the client to the issued invoice                  |
| **Payeer**          | direct                          | (url) A link to redirect the client to the direct payment page on the wallet |
| **BITCOIN (BTC)**   | manual                          | (number) The BTC wallet number for payment                                 |
| **Other Merchants** | direct                          | (url) A link to the merchant‚Äôs payment form                                |

Each element in **payment_variants** includes:
- **error** (mandatory; null if no error, otherwise a text description explaining why the method cannot be used).
- One of the following payment details is required:
  - **url**: The URL of the payment system for redirection.
  - **number**: Payment details for manual transfers.
- **note** (an optional textual note to assist developers during integration).

### Order.details ‚Äî Additional Details About the Order (Used in Responses)
Currently, for payouts from some payment systems, receipts are generated in `Order.details.receipts`. Clients can download these receipts to confirm the payment.
```js
{
    "details": {
        "comment_for_client": "{{comment_for_client}}",
        "payout_receipts": {
            "{{payment_system_transaction_id}}": {
                "pdf": "{{https://************.pdf}}",
                "jpeg": "{{https://************.jpeg}}",
                "amount": {{amount}}
            },
            ...
        }
    }
}
```

## API Methods

### Retrieving Orders
‚ö†Ô∏è We do not recommend polling this method frequently to avoid delays. For notifications about order status changes, please use the [webhook notifications for order statuses](#webhook-notifications-for-order-statuses) feature.

**[GET] /{{API_PARTNERS_PREFIX}}/orders?ids={{id1}},{{id2}},...&page={{pages_count}}&per_page={{items_count}}**
- **ids**: Comma-separated partner order IDs (a single order may be specified).
- **page**: Optional parameter for the page number to retrieve.
- **per_page**: Number of items per page.

#### Successful Response (200)
```js
{
    "success": 1,
    "code": 200,
    "data": {
        "total": {{Total number of items}},
        "per_page": {{Items per page}},
        "page": {{Current page}},
        "orders": {
            "{{Partner order ID}}": {{Order}},
            ...
        }
    }
}
```
*See also: Schema of the "Order" Object.*

If no orders match your query parameters, the `data.orders` field will be an empty object. If you use this method to poll order statuses (which is highly discouraged but sometimes necessary), ensure you check for the presence of your orders in the object keys.

### Creating Orders
This request creates orders. After an order is created, you must [make a payment using the provided payment details](#orderpayment_variants-possible-payment-methods-for-the-order-by-the-client-used-in-responses) from the response to complete it.

**[POST] /{{API_PARTNERS_PREFIX}}/orders**
```js
{
    "orders": [
        {{Order}},
        ...
    ]
}
```
*See also: Schema of the "Order" Object.*

**Please Note:**
1. You cannot create an order with the same ID from the same partner.
2. When creating orders, the `inbound.account` field is sometimes not required (e.g., for a MineCoin payout).
3. It is acceptable to specify only one amount ‚Äî either the amount to be received (`inbound.amount`) or the payout amount (`outbound.amount`). The other amount is calculated automatically based on rates and commissions.
4. It is mandatory to include extra parameters with data about the order and the user in your system.
5. You may include a "comment" field for your convenience; however, the recipient will not see it. This field appears only in the API order information and in your personal account.

üí° If you have a case where the order ID need not match your system's ID, the API can generate a random order ID. To do this, specify:
```js
{
    "order_id": "auto-uid"
}
```

#### Successful Response (200)
```js
{
    "success": 1,
    "code": 200,
    "data": {
        "invalid": {
            "{{Partner order ID}}": "{{Error message}}",
            ...
        },
        "created": {
            "{{Partner order ID}}": {{Order}},
            ...
        }
    }
}
```

### Confirming Order Payment
‚ÑπÔ∏è Orders can only be confirmed when in the **new** status. Confirmation is required if the `is_customer_confirmation_need` flag in the Order object is set to `true`.

**[PUT] /{{API_PARTNERS_PREFIX}}/orders/confirm-by-customer**
```js
{
    "ids": [
        "{{Partner order ID}}",
        ...
    ]
}
```

#### Successful Response (200)
```js
{
    "success": 1,
    "code": 200,
    "data": {
        "invalid": {
            "{{Partner order ID}}": "{{Reason for confirmation failure}}",
            ...
        },
        "confirmed": {
            "{{Partner order ID}}": {{Order}},
            ...
        }
    }
}
```
*See also: Schema of the "Order" Object.*

### Canceling Orders
In certain critical cases, partners may need to cancel created orders before the payout process begins.

‚ÑπÔ∏è Cancellation is permitted only for orders in the **new** or **processing** statuses. If the payment process has begun, cancellation via this API method is not possible; in that case, contact our operators immediately.

**[DELETE] /{{API_PARTNERS_PREFIX}}/orders**
```js
{
    "ids": [
        "{{Partner order ID}}",
        ...
    ]
}
```

#### Successful Response (200)
```js
{
    "success": 1,
    "code": 200,
    "data": {
        "invalid": {
            "{{Partner order ID}}": "{{Error message}}",
            ...
        },
        "canceled": {
            "{{Partner order ID}}": {{Order}},
            ...
        }
    }
}
```
*See also: Schema of the "Order" Object.*

### Retrieving MineCoin Balances
Retrieve the balances of the deposit account in our system (each account is tied to a specific currency).

**[GET] /{{API_PARTNERS_PREFIX}}/balances**

#### Successful Response (200)
```js
{
    "success": 1,
    "code": 200,
    "data": {
        "BTC": {{Balance amount}},
        "USDT": {{Balance amount}},
        "UAH": {{Balance amount}}
    }
}
```

### Retrieving Current Pairs, Rates, Minimum/Maximum Amount Limits, and Reserves
**[GET] /{{API_PARTNERS_PREFIX}}/pairs?names={{CurrencyA}}:{{CurrencyB}},{{CurrencyX}}:{{CurrencyY}},...&inbound_currencies={{CurrencyA}},{{CurrencyB}},...&outbound_currencies={{CurrencyA}},{{CurrencyB}}**
- **names**: Optional, comma-separated pair names in the format `"{{CurrencyA}}:{{CurrencyB}}"`
- **inbound_currencies**: Optional, comma-separated inbound currency codes.
- **outbound_currencies**: Optional, comma-separated outbound currency codes.

#### Successful Response (200)
```js
{
    "success": 1,
    "code": 200,
    "data": {
        "{{CurrencyA}}:{{CurrencyB}}": {
            "inbound": {
                "currency": "CurrencyA",
                "rate": {{Exchange rate (usually one rate is 1 and the other is fractional)}},
                "is_account_required": {{Indicates whether the 'account' field is required when creating an order}}
            },
            "outbound": {
                "currency": "CurrencyB",
                "rate": {{Exchange rate (usually one rate is 1 and the other is fractional)}},
                "is_account_required": {{Indicates whether the 'account' field is required when creating an order}}
            },
            "rate": {{Overall exchange rate for the pair}},
            "min_amount": {{Minimum amount available for processing}},
            "max_amount": "{{Maximum amount available for processing}}",
            "reserve": {{Available reserve of the payout currency}}
        },
        ...
    }
}
```

### Webhook Notifications for Order Statuses
You can subscribe a URL on your server to receive notifications about order status changes.

The **Callback URL** is specified in your personal account under the **API Settings** tab. When an order's status changes, the system will send an HTTP **POST** request to your Callback URL with a body containing the **Order** object.

Your server must respond with a **2XX** status code. If not, the webhook will be retried with increasing delays (up to 10 attempts, though this may change without notice).

For testing, you can use the tool [webhook.site](https://webhook.site) to obtain a URL and monitor incoming notifications.

### Verifying the Authenticity of Webhook Notifications
For security, webhook notifications include a signature that hashes the request body using the signature key.

We strongly recommend verifying this signature on your side by comparing the signature received in the `X-Signature` header with the one generated locally using the same algorithm as for [Signing API Requests](#signing-api-requests).
